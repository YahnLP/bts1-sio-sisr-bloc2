---
author: YLP
title: ğŸ–¥ï¸ FICHE DE TP
---

# ğŸ–¥ï¸ FICHE TP Ã‰LÃˆVE
## TP S15 â€” LAMP + SSH ClÃ©s + Script de Sauvegarde Cron

*DurÃ©e : ~2h30 â€” En binÃ´me â€” VM Linux (Debian/Ubuntu)*

---

## Contexte

SimIO SARL vous confie la mise en place de son serveur applicatif interne. Ce TP est structurÃ© en 4 parties progressives, chacune s'appuyant sur la prÃ©cÃ©dente :
- **A** : Installer et valider la pile LAMP
- **B** : Exercices Bash sur les boucles
- **C** : Configurer SSH par clÃ©s et sÃ©curiser l'accÃ¨s
- **D** : Script de sauvegarde automatisÃ©e planifiÃ© avec cron

---

## PARTIE A â€” Installation de la Pile LAMP

### A1 â€” Mise Ã  Jour du SystÃ¨me

```bash
sudo apt update && sudo apt upgrade -y
```

---

### A2 â€” Installation d'Apache

```bash
# Installer Apache
sudo apt install apache2 -y

# VÃ©rifier qu'Apache fonctionne
sudo systemctl status apache2

# S'assurer qu'il dÃ©marre au boot
sudo systemctl enable apache2
```

âœ… **Test** : Ouvrir un navigateur sur la VM cliente et taper l'adresse IP du serveur. La **page par dÃ©faut Apache** ("Apache2 Default Page") doit s'afficher.

Capturer cette page : **Capture A1**.

---

### A3 â€” Installation de MariaDB

```bash
# Installer MariaDB
sudo apt install mariadb-server -y

# DÃ©marrer et activer au boot
sudo systemctl enable --now mariadb

# VÃ©rifier le statut
sudo systemctl status mariadb
```

**SÃ©curiser l'installation MariaDB :**

```bash
sudo mysql_secure_installation
```

RÃ©pondre aux questions comme suit :

| **Question** | **RÃ©ponse recommandÃ©e** |
|---|---|
| Set root password ? | **Yes** â€” dÃ©finir un mot de passe fort |
| Remove anonymous users ? | **Yes** |
| Disallow root login remotely ? | **Yes** |
| Remove test database ? | **Yes** |
| Reload privilege tables ? | **Yes** |

âœ… **Test** : Se connecter Ã  MariaDB

```bash
sudo mysql -u root -p
# Taper le mot de passe dÃ©fini ci-dessus
# RÃ©sultat attendu : prompt "MariaDB [(none)]>"
```

Capturer le prompt MariaDB : **Capture A2**. Puis `EXIT;`

---

### A4 â€” Installation de PHP

```bash
# Installer PHP et le module Apache + connecteur MariaDB
sudo apt install php libapache2-mod-php php-mysql -y

# VÃ©rifier la version installÃ©e
php -v
```

---

### A5 â€” CrÃ©er une Page de Test PHP

```bash
# CrÃ©er le fichier de test (Ã  supprimer aprÃ¨s validation !)
sudo nano /var/www/html/test.php
```

Contenu du fichier :

```php
<?php
echo "<h1>âœ… PHP fonctionne sur le serveur SimIO !</h1>";
echo "<p>Version PHP : " . phpversion() . "</p>";
echo "<p>Date et heure serveur : " . date('d/m/Y H:i:s') . "</p>";
phpinfo();
?>
```

Sauvegarder et tester depuis le navigateur : `http://[IP_SERVEUR]/test.php`

âœ… Capturer la page phpinfo : **Capture A3**.

```bash
# âš ï¸ SUPPRIMER le fichier de test aprÃ¨s validation (rÃ¨gle de sÃ©curitÃ©)
sudo rm /var/www/html/test.php
```

---

### A6 â€” CrÃ©er une Base de DonnÃ©es et un Utilisateur DÃ©diÃ©

```bash
sudo mysql -u root -p
```

Dans le prompt MariaDB :

```sql
-- CrÃ©er la base de donnÃ©es pour l'application
CREATE DATABASE siosarl_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- CrÃ©er un utilisateur dÃ©diÃ© (ne jamais utiliser root pour l'application)
CREATE USER 'webuser'@'localhost' IDENTIFIED BY 'SioSarl!Web2024';

-- Accorder les droits nÃ©cessaires
GRANT ALL PRIVILEGES ON siosarl_db.* TO 'webuser'@'localhost';

-- Recharger les droits
FLUSH PRIVILEGES;

-- VÃ©rifier
SHOW DATABASES;
SELECT user, host FROM mysql.user;

EXIT;
```

âœ… Capturer les rÃ©sultats de `SHOW DATABASES` et `SELECT user` : **Capture A4**.

---

### A7 â€” CrÃ©er une Page PHP de Connexion BDD

```bash
sudo nano /var/www/html/connexion_bdd.php
```

```php
<?php
$serveur   = "localhost";
$login_bdd = "webuser";
$mdp_bdd   = "SioSarl!Web2024";
$base      = "siosarl_db";

try {
    $pdo = new PDO(
        "mysql:host=$serveur;dbname=$base;charset=utf8mb4",
        $login_bdd,
        $mdp_bdd
    );
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    echo "<h2 style='color:green'>âœ… Connexion Ã  MariaDB rÃ©ussie !</h2>";
    echo "<p>Base de donnÃ©es : <strong>$base</strong></p>";
    echo "<p>Serveur : <strong>$serveur</strong></p>";
} catch (PDOException $e) {
    echo "<h2 style='color:red'>âŒ Erreur de connexion</h2>";
    echo "<p>" . htmlspecialchars($e->getMessage()) . "</p>";
}
?>
```

Tester dans le navigateur : `http://[IP_SERVEUR]/connexion_bdd.php`

âœ… Capturer le message de succÃ¨s : **Capture A5**.

---

## PARTIE B â€” Exercices Bash : Boucles

### B1 â€” Inventaire des Services LAMP

CrÃ©er `/home/user/scripts/verif_lamp.sh` :

```bash
#!/bin/bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Script  : verif_lamp.sh
# RÃ´le    : VÃ©rifier l'Ã©tat des services de la pile LAMP
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo "================================================="
echo "    VÃ‰RIFICATION DE LA PILE LAMP â€” SimIO SARL"
echo "    $(date '+%d/%m/%Y Ã  %H:%M:%S')"
echo "================================================="
echo ""

SERVICES=("apache2" "mariadb" "php8.2-fpm")
TOUS_OK=true

for SERVICE in "${SERVICES[@]}"
do
    # VÃ©rifier si le paquet est installÃ©
    if ! dpkg -l "$SERVICE" > /dev/null 2>&1
    then
        echo "  [N/A]  $SERVICE â€” Non installÃ©"
        continue
    fi

    # VÃ©rifier si le service est actif
    if systemctl is-active --quiet "$SERVICE"
    then
        echo "  [âœ… OK] $SERVICE est ACTIF"
    else
        echo "  [âŒ KO] $SERVICE est INACTIF !"
        TOUS_OK=false
    fi
done

echo ""
if [ "$TOUS_OK" = true ]
then
    echo "âœ… Pile LAMP opÃ©rationnelle."
else
    echo "âš ï¸  Un ou plusieurs services LAMP sont inactifs. VÃ©rifiez les logs !"
fi
```

```bash
chmod +x verif_lamp.sh
./verif_lamp.sh
```

---

### B2 â€” Analyse de Fichier : Extraire les Utilisateurs SystÃ¨me

CrÃ©er `/home/user/scripts/liste_users.sh` :

```bash
#!/bin/bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Script  : liste_users.sh
# RÃ´le    : Lister les utilisateurs avec shell valide
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo "=== Utilisateurs avec un shell valide ==="
echo ""

COMPTEUR=0

while IFS=: read -r LOGIN MDPH UID GID INFO HOME SHELL
do
    # Ne lister que les utilisateurs avec un shell interactif
    if [ "$SHELL" = "/bin/bash" ] || [ "$SHELL" = "/bin/sh" ]
    then
        COMPTEUR=$(( COMPTEUR + 1 ))
        echo "  $COMPTEUR. Login: $LOGIN | UID: $UID | Home: $HOME | Shell: $SHELL"
    fi
done < /etc/passwd

echo ""
echo "Total : $COMPTEUR utilisateur(s) avec shell interactif."
```

```bash
chmod +x liste_users.sh
./liste_users.sh
```

---

## PARTIE C â€” SSH par ClÃ©s Publique/PrivÃ©e

> ğŸ’¡ **Configuration :** La VM cliente (poste depuis lequel vous vous connectez) et la VM serveur LAMP doivent Ãªtre sur le mÃªme rÃ©seau virtuel. Notez l'IP de la VM serveur : `_______________`

### C1 â€” GÃ©nÃ©rer une Paire de ClÃ©s SSH sur la VM Cliente

Sur la **VM cliente** (pas le serveur LAMP) :

```bash
# GÃ©nÃ©rer une paire de clÃ©s Ed25519 (algorithme moderne recommandÃ©)
ssh-keygen -t ed25519 -C "admin@siosarl.local"

# Ã€ la question "Enter file in which to save the key" : appuyer sur EntrÃ©e (chemin par dÃ©faut)
# Ã€ la question "Enter passphrase" : laisser vide (pour le TP) ou saisir une passphrase

# VÃ©rifier les clÃ©s gÃ©nÃ©rÃ©es
ls -la ~/.ssh/
# â†’ id_ed25519 (privÃ©e, permissions 600) et id_ed25519.pub (publique)

# Afficher la clÃ© publique
cat ~/.ssh/id_ed25519.pub
```

âœ… Capturer la sortie de `ls -la ~/.ssh/` : **Capture C1**.

---

### C2 â€” Copier la ClÃ© Publique sur le Serveur

```bash
# MÃ©thode automatique (recommandÃ©e)
ssh-copy-id -i ~/.ssh/id_ed25519.pub user@[IP_SERVEUR]
# â†’ Entrer le mot de passe habituel une derniÃ¨re fois

# VÃ©rifier que la clÃ© a bien Ã©tÃ© ajoutÃ©e sur le serveur
ssh user@[IP_SERVEUR] "cat ~/.ssh/authorized_keys"
```

---

### C3 â€” Tester la Connexion par ClÃ©

```bash
# Se connecter sans mot de passe
ssh user@[IP_SERVEUR]
# â†’ La connexion doit s'Ã©tablir SANS demander de mot de passe
```

âœ… Capturer la connexion sans mot de passe : **Capture C2**.

---

### C4 â€” SÃ©curiser le Serveur SSH

Sur la **VM serveur** :

```bash
# Sauvegarder la configuration avant modification
sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup

# Modifier la configuration
sudo nano /etc/ssh/sshd_config
```

Modifier/vÃ©rifier les lignes suivantes :

```
PermitRootLogin no
PasswordAuthentication no
PubkeyAuthentication yes
MaxAuthTries 3
```

```bash
# VÃ©rifier la syntaxe avant de redÃ©marrer (Ã©vite de se bloquer dehors !)
sudo sshd -t

# RedÃ©marrer SSH
sudo systemctl restart ssh

# Tester depuis la VM cliente que la connexion par clÃ© fonctionne toujours
ssh user@[IP_SERVEUR]
```

âœ… Capturer le rÃ©sultat de `sudo sshd -t` (doit Ãªtre silencieux = OK) : **Capture C3**.

---

## PARTIE D â€” Script de Sauvegarde AutomatisÃ©e avec Cron

### Contexte

SimIO SARL vous demande de mettre en place une **sauvegarde nocturne automatique** du site web (`/var/www/html`) et de la configuration Apache (`/etc/apache2`). Cette sauvegarde doit :

- ÃŠtre exÃ©cutÃ©e **tous les jours Ã  2h00**
- CrÃ©er une archive compressÃ©e **horodatÃ©e**
- Conserver les **7 derniÃ¨res sauvegardes** seulement
- **Journaliser** chaque opÃ©ration avec horodatage
- Envoyer un **compte-rendu** lisible (succÃ¨s ou Ã©chec de chaque Ã©tape)

---

### D1 â€” PrÃ©parer l'Environnement

```bash
# CrÃ©er le rÃ©pertoire de sauvegardes
sudo mkdir -p /var/backups/siosarl

# CrÃ©er le rÃ©pertoire des scripts d'administration
sudo mkdir -p /usr/local/bin/siosarl

# CrÃ©er quelques fichiers de test dans le site web
echo "<h1>Page d'accueil SimIO</h1>" | sudo tee /var/www/html/index.html
echo "<?php echo 'App SimIO'; ?>" | sudo tee /var/www/html/app.php
sudo mkdir -p /var/www/html/assets
```

---

### D2 â€” Ã‰crire le Script de Sauvegarde

```bash
sudo nano /usr/local/bin/siosarl/sauvegarde.sh
```

```bash
#!/bin/bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Script  : sauvegarde.sh
# Auteur  : [Votre nom]
# Date    : [Date]
# Version : 1.0
# RÃ´le    : Sauvegarde automatique du serveur web SimIO SARL
#           - Sauvegarde /var/www/html et /etc/apache2
#           - Archives horodatÃ©es compressÃ©es en .tar.gz
#           - Conservation des 7 derniÃ¨res sauvegardes (rotation)
#           - Journalisation complÃ¨te dans /var/log/sauvegarde_siosarl.log
# Epreuve : Portfolio BTS SIO SISR â€” CompÃ©tences B2.4 et B2.5
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# â”€â”€â”€ VARIABLES DE CONFIGURATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
REPERTOIRES_SOURCE=("/var/www/html" "/etc/apache2")
REPERTOIRE_BACKUP="/var/backups/siosarl"
FICHIER_LOG="/var/log/sauvegarde_siosarl.log"
NB_SAUVEGARDES_MAX=7
PREFIXE="backup_siosarl"
DATE=$(date "+%Y-%m-%d_%H-%M-%S")
NOM_ARCHIVE="${PREFIXE}_${DATE}.tar.gz"
CHEMIN_ARCHIVE="${REPERTOIRE_BACKUP}/${NOM_ARCHIVE}"
STATUT_GLOBAL=0   # 0 = succÃ¨s, 1 = Ã©chec

# â”€â”€â”€ FONCTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Fonction d'Ã©criture dans le log
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$FICHIER_LOG"
}

# Fonction de vÃ©rification du code retour
verifier() {
    if [ $? -eq 0 ]
    then
        log "  âœ… $1 â€” OK"
    else
        log "  âŒ $1 â€” ECHEC !"
        STATUT_GLOBAL=1
    fi
}

# â”€â”€â”€ DÃ‰BUT DU SCRIPT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
log "========================================================"
log " DÃ‰BUT DE SAUVEGARDE â€” SimIO SARL"
log " Archive : $NOM_ARCHIVE"
log "========================================================"

# â”€â”€â”€ VÃ‰RIFICATION DU RÃ‰PERTOIRE DE BACKUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [ ! -d "$REPERTOIRE_BACKUP" ]
then
    log "CrÃ©ation du rÃ©pertoire de backup : $REPERTOIRE_BACKUP"
    mkdir -p "$REPERTOIRE_BACKUP"
    verifier "CrÃ©ation rÃ©pertoire backup"
fi

# â”€â”€â”€ VÃ‰RIFICATION DES SOURCES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
log "VÃ©rification des rÃ©pertoires sources..."
for SOURCE in "${REPERTOIRES_SOURCE[@]}"
do
    if [ -d "$SOURCE" ]
    then
        TAILLE=$(du -sh "$SOURCE" | cut -f1)
        log "  âœ… Source OK : $SOURCE ($TAILLE)"
    else
        log "  âš ï¸  Source absente ou vide : $SOURCE â€” IgnorÃ©."
    fi
done

# â”€â”€â”€ CRÃ‰ATION DE L'ARCHIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
log "CrÃ©ation de l'archive : $NOM_ARCHIVE"

tar -czf "$CHEMIN_ARCHIVE" \
    "${REPERTOIRES_SOURCE[@]}" \
    2>> "$FICHIER_LOG"

verifier "CrÃ©ation archive tar.gz"

# â”€â”€â”€ VÃ‰RIFICATION DE L'ARCHIVE CRÃ‰Ã‰E â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [ -f "$CHEMIN_ARCHIVE" ]
then
    TAILLE_ARCHIVE=$(du -sh "$CHEMIN_ARCHIVE" | cut -f1)
    log "Archive crÃ©Ã©e avec succÃ¨s : $CHEMIN_ARCHIVE ($TAILLE_ARCHIVE)"

    # VÃ©rifier l'intÃ©gritÃ© de l'archive
    tar -tzf "$CHEMIN_ARCHIVE" > /dev/null 2>&1
    verifier "VÃ©rification intÃ©gritÃ© de l'archive"
else
    log "âŒ ERREUR CRITIQUE : l'archive n'a pas Ã©tÃ© crÃ©Ã©e !"
    STATUT_GLOBAL=1
fi

# â”€â”€â”€ ROTATION DES SAUVEGARDES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
log "Rotation des sauvegardes (conservation des $NB_SAUVEGARDES_MAX derniÃ¨res)..."

NB_ARCHIVES=$(ls -1 "${REPERTOIRE_BACKUP}/${PREFIXE}_"*.tar.gz 2>/dev/null | wc -l)
log "  Nombre d'archives prÃ©sentes : $NB_ARCHIVES"

if [ "$NB_ARCHIVES" -gt "$NB_SAUVEGARDES_MAX" ]
then
    NB_A_SUPPRIMER=$(( NB_ARCHIVES - NB_SAUVEGARDES_MAX ))
    log "  Suppression des $NB_A_SUPPRIMER archive(s) les plus anciennes..."

    ls -1t "${REPERTOIRE_BACKUP}/${PREFIXE}_"*.tar.gz \
        | tail -n "$NB_A_SUPPRIMER" \
        | while read -r ANCIENNE_ARCHIVE
    do
        rm -f "$ANCIENNE_ARCHIVE"
        log "  ğŸ—‘ï¸  SupprimÃ© : $(basename $ANCIENNE_ARCHIVE)"
    done
else
    log "  Aucune rotation nÃ©cessaire."
fi

# â”€â”€â”€ RAPPORT FINAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
NB_ARCHIVES_FINAL=$(ls -1 "${REPERTOIRE_BACKUP}/${PREFIXE}_"*.tar.gz 2>/dev/null | wc -l)

log "========================================================"
if [ $STATUT_GLOBAL -eq 0 ]
then
    log " âœ… SAUVEGARDE TERMINÃ‰E AVEC SUCCÃˆS"
else
    log " âŒ SAUVEGARDE TERMINÃ‰E AVEC DES ERREURS â€” Consultez le log"
fi
log " Archives conservÃ©es : $NB_ARCHIVES_FINAL / $NB_SAUVEGARDES_MAX maximum"
log " Espace backup utilisÃ© : $(du -sh $REPERTOIRE_BACKUP | cut -f1)"
log "========================================================"
log ""

exit $STATUT_GLOBAL
```

---

### D3 â€” Rendre le Script ExÃ©cutable et le Tester

```bash
# Rendre exÃ©cutable
sudo chmod +x /usr/local/bin/siosarl/sauvegarde.sh

# Tester manuellement (toujours tester avant de planifier !)
sudo /usr/local/bin/siosarl/sauvegarde.sh

# VÃ©rifier le rÃ©sultat
ls -lh /var/backups/siosarl/
cat /var/log/sauvegarde_siosarl.log
```

âœ… Capturer la liste des archives crÃ©Ã©es : **Capture D1**.
âœ… Capturer le contenu du log : **Capture D2**.

---

### D4 â€” Tester la Rotation

Simuler plusieurs sauvegardes pour tester la rotation :

```bash
# Relancer le script 3 fois de suite pour crÃ©er plusieurs archives
for i in $(seq 1 3)
do
    echo "=== ExÃ©cution $i ==="
    sudo /usr/local/bin/siosarl/sauvegarde.sh
    sleep 2   # Attendre 2 secondes pour avoir des horodatages diffÃ©rents
done

# VÃ©rifier que la rotation fonctionne (au-delÃ  de 7 archives)
ls -lh /var/backups/siosarl/
```

---

### D5 â€” Planifier avec Cron

```bash
# Ã‰diter le crontab de root
sudo crontab -e
```

Ajouter la ligne suivante :

```
# Sauvegarde quotidienne du serveur web SimIO SARL Ã  2h00
0 2 * * * /usr/local/bin/siosarl/sauvegarde.sh >> /var/log/sauvegarde_siosarl.log 2>&1
```

```bash
# VÃ©rifier que la tÃ¢che est bien enregistrÃ©e
sudo crontab -l
```

âœ… Capturer la sortie de `sudo crontab -l` : **Capture D3**.

---

### D6 â€” VÃ©rifier la Planification (Test ImmÃ©diat)

Pour vÃ©rifier que cron exÃ©cute bien le script, on peut temporairement modifier l'heure de planification pour qu'elle se dÃ©clenche dans 2 minutes :

```bash
# ConnaÃ®tre l'heure actuelle
date

# Modifier le crontab pour un test dans 2 minutes (exemple : si 10h15, mettre 10 17)
# 17 10 * * * /usr/local/bin/siosarl/sauvegarde.sh ...

# AprÃ¨s l'exÃ©cution, vÃ©rifier le log
cat /var/log/sauvegarde_siosarl.log

# Remettre la planification Ã  2h00
sudo crontab -e
# Corriger : 0 2 * * * ...
```

âœ… Capturer la derniÃ¨re entrÃ©e du log aprÃ¨s exÃ©cution automatique : **Capture D4**.

---

---

# ğŸ“„ ANNEXE â€” FICHE DE DOCUMENTATION LAMP & SAUVEGARDE
## (Ã€ complÃ©ter et verser au portfolio â€” Preuve E4/E5)

*Nom : _________________________ PrÃ©nom : _________________________ Date : _________*

---

## 1. Configuration du Serveur LAMP

### Informations SystÃ¨me

| **ParamÃ¨tre** | **Valeur** |
|---|---|
| Distribution Linux | |
| Version du noyau (`uname -r`) | |
| Adresse IP du serveur | |
| Nom d'hÃ´te (`hostname`) | |

### Composants LAMP InstallÃ©s

| **Composant** | **Version** | **Port** | **Statut** | **DÃ©marrage auto** |
|---|---|---|---|---|
| Apache | | 80/443 | | |
| MariaDB | | 3306 | | |
| PHP | | N/A | | |

### Base de DonnÃ©es CrÃ©Ã©e

| **ParamÃ¨tre** | **Valeur** |
|---|---|
| Nom de la base | siosarl_db |
| Utilisateur applicatif | webuser |
| HÃ´te autorisÃ© | localhost |
| Droits accordÃ©s | ALL PRIVILEGES |

---

## 2. Configuration SSH

| **ParamÃ¨tre** | **Valeur** |
|---|---|
| Type de clÃ© gÃ©nÃ©rÃ©e | Ed25519 |
| Emplacement clÃ© privÃ©e | ~/.ssh/id_ed25519 |
| Emplacement clÃ© publique | ~/.ssh/id_ed25519.pub |
| Fichier authorized_keys serveur | ~/.ssh/authorized_keys |
| PermitRootLogin | no |
| PasswordAuthentication | no |

---

## 3. Configuration du Script de Sauvegarde

| **ParamÃ¨tre** | **Valeur configurÃ©e** |
|---|---|
| Chemin du script | /usr/local/bin/siosarl/sauvegarde.sh |
| RÃ©pertoires sauvegardÃ©s | /var/www/html, /etc/apache2 |
| RÃ©pertoire de destination | /var/backups/siosarl |
| Fichier de log | /var/log/sauvegarde_siosarl.log |
| Nombre de sauvegardes conservÃ©es | 7 |
| Format du nom d'archive | backup_siosarl_YYYY-MM-DD_HH-MM-SS.tar.gz |

---

## 4. Planification Cron

| **ParamÃ¨tre** | **Valeur** |
|---|---|
| Expression cron | 0 2 * * * |
| Signification | Tous les jours Ã  2h00 |
| Utilisateur | root |
| Redirections | >> /var/log/sauvegarde_siosarl.log 2>&1 |

*Coller ici le rÃ©sultat de `sudo crontab -l` :*

```
(rÃ©sultat de crontab -l)
```

---

## 5. Tests de Validation

| **Test** | **Commande utilisÃ©e** | **RÃ©sultat** | **Capture NÂ°** |
|---|---|---|---|
| Apache actif | `systemctl status apache2` | âœ… / âŒ | |
| Page web accessible | Navigateur â†’ IP serveur | âœ… / âŒ | |
| PHP fonctionnel | `php -v` | âœ… / âŒ | |
| MariaDB actif | `systemctl status mariadb` | âœ… / âŒ | |
| Connexion BDD via PHP | `http://IP/connexion_bdd.php` | âœ… / âŒ | |
| SSH clÃ© sans MDP | `ssh user@IP` | âœ… / âŒ | |
| Script sauvegarde manuel | `sudo ./sauvegarde.sh` | âœ… / âŒ | |
| Archive crÃ©Ã©e | `ls /var/backups/siosarl/` | âœ… / âŒ | |
| Rotation (>7 archives) | ExÃ©cution x8 + vÃ©rification | âœ… / âŒ | |
| Planification cron | `sudo crontab -l` | âœ… / âŒ | |

---
